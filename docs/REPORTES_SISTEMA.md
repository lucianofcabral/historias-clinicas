# Sistema de Reportes y Exportaci√≥n

## üìã Descripci√≥n

Sistema completo de generaci√≥n de reportes m√©dicos en formato PDF y Excel, con exportaci√≥n directa desde la interfaz.

## ‚ú® Caracter√≠sticas Implementadas

### 1. **Servicio de Reportes** (`app/services/report_service.py`)

#### Historial Completo de Paciente
- **PDF:** Documento profesional con:
  - Datos personales del paciente
  - Antecedentes m√©dicos (alergias, condiciones cr√≥nicas, historia familiar)
  - Lista completa de consultas con signos vitales
  - Estudios m√©dicos realizados
  - Formato con colores y tablas profesionales
  
- **Excel:** Libro con 3 hojas:
  - **Hoja 1:** Datos del paciente
  - **Hoja 2:** Todas las consultas con detalles
  - **Hoja 3:** Estudios m√©dicos (estudios cr√≠ticos resaltados en rojo)

#### Reporte de Consultas
- **PDF:** Lista de consultas con filtro por fechas
  - Tabla con fecha, paciente, motivo y diagn√≥stico
  - Estad√≠sticas (total de consultas)
  - Formato limpio para impresi√≥n

#### Reporte de Estudios M√©dicos
- **Excel:** Reporte completo de estudios
  - Filtros por tipo de estudio
  - Filtros por rango de fechas
  - Estudios cr√≠ticos resaltados
  - Columnas: Fecha, Paciente, Tipo, Nombre, Instituci√≥n, M√©dico, Resultados, Diagn√≥stico, Estado

### 2. **Interfaz de Usuario** (`app/pages/reports.py`)

#### P√°gina de Reportes
- **3 Tarjetas Principales:**

1. **Historial Completo:**
   - Selector de paciente (lista completa con DNI)
   - Opci√≥n PDF o Excel
   - Bot√≥n de generaci√≥n inmediata
   
2. **Reporte de Consultas:**
   - Filtros de fecha (inicio y fin)
   - Formato PDF
   - Genera tabla de consultas del per√≠odo
   
3. **Reporte de Estudios:**
   - Selector de tipo de estudio (Laboratorio, Radiolog√≠a, etc.)
   - Filtros de fecha
   - Formato Excel
   - Estudios cr√≠ticos resaltados

#### Exportaci√≥n R√°pida
- **Botones en Detalle de Paciente:**
  - "Exportar PDF" ‚Üí Descarga inmediata del historial en PDF
  - "Exportar Excel" ‚Üí Descarga inmediata en formato Excel
  - Ubicados en la barra superior junto al bot√≥n "Volver"

### 3. **Estado y L√≥gica** (`app/state/report_state.py`)

- Manejo de filtros y par√°metros
- Validaci√≥n de datos
- Generaci√≥n as√≠ncrona
- Manejo de errores
- Descarga autom√°tica de archivos

## üé® Dise√±o

### Colores y Estilos en PDF
- **Azul (#2563eb):** T√≠tulos y encabezados
- **Gris claro:** Fondos alternados para mejor lectura
- **Rojo claro:** Alertas y estudios cr√≠ticos
- **Amarillo claro:** Antecedentes m√©dicos
- Tablas con bordes y padding para legibilidad

### Colores en Excel
- **Azul fuerte:** Encabezados de tablas
- **Azul claro:** Subt√≠tulos de secciones
- **Rojo claro:** Estudios cr√≠ticos
- Bordes en todas las celdas
- Auto-ajuste de columnas
- Text wrap activado

## üìÑ Tipos de Reportes

### Historial Completo de Paciente

**Contenido:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   HISTORIA CL√çNICA COMPLETA         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ DATOS DEL PACIENTE                  ‚îÇ
‚îÇ - Nombre, DNI, Fecha Nacimiento     ‚îÇ
‚îÇ - G√©nero, Tipo de Sangre            ‚îÇ
‚îÇ - Contacto (Tel, Email, Direcci√≥n)  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ANTECEDENTES M√âDICOS                ‚îÇ
‚îÇ - Alergias                          ‚îÇ
‚îÇ - Condiciones Cr√≥nicas              ‚îÇ
‚îÇ - Antecedentes Familiares           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ CONSULTAS (con paginaci√≥n)          ‚îÇ
‚îÇ Para cada consulta:                 ‚îÇ
‚îÇ - Fecha, Motivo, S√≠ntomas           ‚îÇ
‚îÇ - Diagn√≥stico, Tratamiento          ‚îÇ
‚îÇ - Signos Vitales                    ‚îÇ
‚îÇ - Pr√≥xima Visita                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ESTUDIOS M√âDICOS (con paginaci√≥n)   ‚îÇ
‚îÇ Para cada estudio:                  ‚îÇ
‚îÇ - Tipo, Nombre, Fecha               ‚îÇ
‚îÇ - Instituci√≥n, M√©dico               ‚îÇ
‚îÇ - Resultados, Observaciones         ‚îÇ
‚îÇ - Estado (Pendiente/Cr√≠tico/etc)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Reporte de Consultas

**Contenido:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   REPORTE DE CONSULTAS              ‚îÇ
‚îÇ   01/10/2025 - 18/10/2025          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Total de Consultas: 25              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ TABLA:                              ‚îÇ
‚îÇ Fecha | Paciente | Motivo | Diagn√≥stico
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ (Lista de todas las consultas)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Reporte de Estudios

**Contenido Excel:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ REPORTE DE ESTUDIOS M√âDICOS         ‚îÇ
‚îÇ Tipo: Laboratorio | Desde: 01/10   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Fecha | Paciente | Tipo | Nombre |  ‚îÇ
‚îÇ Instituci√≥n | M√©dico | Resultados |  ‚îÇ
‚îÇ Diagn√≥stico | Estado                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ (Lista con estudios cr√≠ticos        ‚îÇ
‚îÇ  resaltados en rojo)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ Uso

### Desde la P√°gina de Reportes

1. Ir a **Reportes** en el men√∫ de navegaci√≥n
2. Seleccionar el tipo de reporte deseado
3. Configurar filtros (paciente, fechas, tipo de estudio)
4. Elegir formato (PDF o Excel seg√∫n disponibilidad)
5. Hacer clic en "Generar Reporte"
6. El archivo se descargar√° autom√°ticamente

### Exportaci√≥n R√°pida desde Detalle de Paciente

1. Ir al detalle de cualquier paciente
2. En la barra superior, junto a "Volver":
   - Hacer clic en **"Exportar PDF"** para PDF inmediato
   - Hacer clic en **"Exportar Excel"** para Excel inmediato
3. El archivo se descarga con el nombre `historial_paciente_{id}.pdf` o `.xlsx`

## üì¶ Dependencias

### Instaladas:
```bash
reportlab    # Generaci√≥n de PDFs
openpyxl     # Generaci√≥n de Excel
```

### Uso en el C√≥digo:
```python
# Generar PDF de historial
from app.services import ReportService

content = ReportService.generate_patient_history_pdf(patient_id)
filename = f"historial_paciente_{patient_id}.pdf"

return rx.download(data=content, filename=filename)
```

## üîß Arquitectura

### Flujo de Generaci√≥n

```
Usuario
  ‚Üì
[UI - reports.py] 
  ‚Üì
[State - report_state.py]
  ‚Üì (valida y procesa)
[Service - report_service.py]
  ‚Üì (consulta DB y genera)
[Database]
  ‚Üì
[ReportLab / OpenPyXL]
  ‚Üì (genera bytes)
[rx.download()]
  ‚Üì
Usuario recibe archivo
```

### M√©todos del Servicio

```python
ReportService.generate_patient_history_pdf(patient_id: int) -> bytes
ReportService.generate_patient_history_excel(patient_id: int) -> bytes
ReportService.generate_consultations_report_pdf(start_date, end_date) -> bytes
ReportService.generate_studies_report_excel(study_type, start_date, end_date) -> bytes
```

## üì± Responsive

- Grid de 3 columnas en pantallas grandes
- Se adapta a pantallas peque√±as
- Botones de exportaci√≥n responsivos
- Formularios con campos apilados en m√≥viles

## üéØ Casos de Uso

### Para M√©dicos
1. **Imprimir historial para paciente:** Exportar PDF del historial completo
2. **An√°lisis de consultas:** Reporte Excel de consultas del mes
3. **Revisi√≥n de estudios:** Filtrar por tipo y exportar a Excel

### Para Administraci√≥n
1. **Estad√≠sticas mensuales:** Reporte de todas las consultas del mes
2. **Auditor√≠a de estudios:** Reporte completo con filtros
3. **Archivo f√≠sico:** Imprimir PDFs para archivo

### Para Pacientes
1. **Historial personal:** Exportar PDF completo para llevar a otros profesionales
2. **Segunda opini√≥n:** PDF con todos los estudios y diagn√≥sticos

## ‚ö†Ô∏è Consideraciones

### Performance
- Los reportes de historiales completos pueden ser grandes si hay muchas consultas/estudios
- Se usa paginaci√≥n autom√°tica en PDFs para manejar contenido extenso
- Los archivos se generan en memoria (BytesIO) para mejor performance

### Seguridad
- Los reportes respetan los permisos de usuario (requieren autenticaci√≥n)
- No se guardan archivos temporales en disco
- Los bytes se generan y descargan directamente

### Limitaciones Actuales
- Reporte de consultas solo en PDF (no Excel)
- Reporte de estudios solo en Excel (no PDF)
- No hay previsualizaci√≥n antes de descargar
- Sin programaci√≥n de reportes autom√°ticos

## üîÆ Mejoras Futuras

- [ ] Previsualizaci√≥n de reportes antes de descargar
- [ ] Reportes programados (env√≠o autom√°tico por email)
- [ ] Gr√°ficos y estad√≠sticas visuales en los reportes
- [ ] Plantillas personalizables
- [ ] Firma digital de m√©dicos en PDFs
- [ ] Watermarks en reportes
- [ ] Compresi√≥n de archivos grandes
- [ ] Historial de reportes generados
- [ ] Exportaci√≥n a otros formatos (CSV, JSON)
- [ ] Reportes batch (m√∫ltiples pacientes)

## üìä Formatos Disponibles

| Tipo de Reporte | PDF | Excel |
|-----------------|-----|-------|
| Historial Completo | ‚úÖ | ‚úÖ |
| Consultas por Fecha | ‚úÖ | ‚ùå |
| Estudios M√©dicos | ‚ùå | ‚úÖ |

## üóÇÔ∏è Archivos del Sistema

```
app/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ report_service.py       # 700+ l√≠neas - Generaci√≥n de reportes
‚îú‚îÄ‚îÄ state/
‚îÇ   ‚îî‚îÄ‚îÄ report_state.py         # 170+ l√≠neas - L√≥gica UI
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ reports.py              # 330+ l√≠neas - Interfaz
‚îî‚îÄ‚îÄ app.py                      # Ruta agregada: /reports
```

## üéâ Caracter√≠sticas Destacadas

- ‚úÖ **Generaci√≥n Inmediata:** Sin esperas, descarga directa
- ‚úÖ **Dise√±o Profesional:** PDFs y Excel con formato corporativo
- ‚úÖ **Filtros Flexibles:** Por fecha, tipo, paciente
- ‚úÖ **Exportaci√≥n R√°pida:** Botones directos en detalle de paciente
- ‚úÖ **Estudios Cr√≠ticos Resaltados:** Visual importante
- ‚úÖ **Informaci√≥n Completa:** Todos los datos relevantes incluidos
- ‚úÖ **Sin Archivos Temporales:** Todo en memoria
- ‚úÖ **F√°cil de Usar:** Interface intuitiva y clara

## üí° Tips de Uso

1. **Para reportes r√°pidos:** Usa los botones de exportaci√≥n en el detalle del paciente
2. **Para an√°lisis:** Usa la p√°gina de Reportes con filtros espec√≠ficos
3. **Para imprimir:** Los PDFs est√°n optimizados para impresi√≥n en papel carta
4. **Para compartir:** Los Excel son f√°ciles de enviar por email y editar
5. **Estudios cr√≠ticos:** Siempre aparecen resaltados para r√°pida identificaci√≥n
